name: Build Decktation Plugin

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check Python syntax
      run: |
        python -m py_compile main.py
        python -m py_compile wow_voice_chat.py
        python -m py_compile controller_listener.py

    - name: Package plugin (lightweight)
      run: |
        # Create package directory
        mkdir -p decktation-package

        # Copy essential files
        cp -r dist decktation-package/
        cp -r defaults decktation-package/ 2>/dev/null || true
        cp main.py decktation-package/
        cp wow_voice_chat.py decktation-package/
        cp controller_listener.py decktation-package/
        cp plugin.json decktation-package/
        cp package.json decktation-package/
        cp README.md decktation-package/
        cp LICENSE decktation-package/ 2>/dev/null || true

        # Copy setup scripts
        cp setup_ydotoold.sh decktation-package/ 2>/dev/null || true
        cp install_deps.sh decktation-package/ 2>/dev/null || true

        # Create install.sh for automatic dependency installation
        cat > decktation-package/install.sh <<'EOF'
        #!/bin/bash
        # Automatically install Python dependencies on plugin install
        PLUGIN_DIR="$(dirname "$0")"
        cd "$PLUGIN_DIR"

        echo "Decktation: Installing Python dependencies..."

        # Detect Python (prefer 3.11 to match Decky)
        if command -v python3.11 &> /dev/null; then
            PYTHON="python3.11"
        else
            PYTHON="python3"
        fi

        echo "Using Python: $PYTHON ($($PYTHON --version))"

        # Install dependencies to lib/
        mkdir -p lib
        $PYTHON -m pip install --target=lib --upgrade \
            faster-whisper \
            sounddevice \
            numpy \
            evdev-binary

        echo "Decktation: Dependencies installed successfully"
        EOF
        chmod +x decktation-package/install.sh

        # Create archive
        cd decktation-package
        tar -czf ../decktation-plugin.tar.gz .
        cd ..
        zip -r decktation-plugin.zip decktation-package/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: decktation-plugin
        path: |
          decktation-plugin.tar.gz
          decktation-plugin.zip

    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          decktation-plugin.tar.gz
          decktation-plugin.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
